<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> TrackEasy </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        .tab-active { background-color: white; color: #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-inactive { color: #64748b; }
        .animate-fade-in { animation: fadeIn 0.15s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        
        .input-field { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background-color: #f8fafc; font-weight: 600; font-size: 13px; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #2563eb; ring: 2px; ring-color: #2563eb; background-color: #fff; }

        .photo-preview { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; border: 2px solid #2563eb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .modal-overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }

        @media print {
            header, #area-registro, #area-acoes, .no-print, .btn-acao, input, .filters-container { display: none !important; }
            body { background: white; padding: 0; }
            .card-unidade { border: 1px solid #eee !important; break-inside: avoid; margin-bottom: 10px; border-radius: 8px !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-10">

    <div id="modal-edit" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl space-y-4 max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="flex justify-between items-center border-b pb-3">
                <h3 class="font-black text-slate-800 uppercase text-sm">Corre√ß√£o de Dados</h3>
                <button onclick="closeEditModal()" class="text-slate-400 p-2"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4 pt-2">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Unidade</label>
                        <input id="edit-unidade" type="text" class="input-field uppercase">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Morador</label>
                        <input id="edit-morador" type="text" class="input-field">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Remetente</label>
                        <input id="edit-remetente" type="text" class="input-field">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Empresa</label>
                        <input id="edit-empresa" type="text" class="input-field">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Descri√ß√£o do Produto</label>
                    <input id="edit-descricao" type="text" class="input-field">
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">NF / Pedido</label>
                        <input id="edit-nf" type="text" class="input-field">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Recebedor</label>
                        <input id="edit-recebedor" type="text" class="input-field">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Portaria at√©</label>
                        <input id="edit-permanencia" type="text" class="input-field" placeholder="Ex: 18:00">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Token / C√≥digo de Sa√≠da</label>
                    <input id="edit-tokens" type="text" class="input-field" placeholder="Ex: 1234">
                </div>
            </div>
            <div class="flex gap-3 pt-4">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-slate-100 text-slate-500 font-black rounded-xl text-xs uppercase">Cancelar</button>
                <button onclick="saveEdit()" class="flex-1 py-3 bg-blue-600 text-white font-black rounded-xl text-xs uppercase shadow-lg">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modal-baixa" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
        <div id="modal-whatsapp" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl space-y-4 animate-fade-in text-center">
            <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-2">
                <i data-lucide="message-circle" class="w-8 h-8"></i>
            </div>
            <h3 class="font-black text-slate-800 uppercase text-lg">WhatsApp Pronto!</h3>
            <p id="wa-numero-display" class="text-xs font-bold text-slate-400 mb-4">Apto --</p>
            <div class="flex gap-3 pt-2">
                <button onclick="document.getElementById('modal-whatsapp').classList.add('hidden')" class="flex-1 py-3 bg-slate-100 text-slate-500 font-black rounded-xl text-xs uppercase">Cancelar</button>
                <a id="btn-wa-enviar" href="#" target="_blank" class="flex-1 py-3 bg-emerald-500 text-white font-black rounded-xl text-xs uppercase shadow-lg flex items-center justify-center gap-2">Abrir App</a>
            </div>
        </div>
    </div>
        <div id="modal-whatsapp" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl space-y-4 animate-fade-in text-center">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-2">
                <i data-lucide="message-circle" class="w-8 h-8"></i>
            </div>
            <h3 class="font-black text-slate-800 uppercase text-lg">WhatsApp Pronto!</h3>
            <p id="wa-numero-display" class="text-xs font-bold text-slate-400 mb-4">Apto --</p>
            <div class="flex gap-3 pt-2">
                <button onclick="document.getElementById('modal-whatsapp').classList.add('hidden')" class="flex-1 py-3 bg-slate-100 text-slate-500 font-black rounded-xl text-xs uppercase">Cancelar</button>
                
                <a id="btn-wa-enviar" href="#" target="_blank" class="flex-1 py-3 bg-green-500 text-white font-black rounded-xl text-xs uppercase shadow-lg flex items-center justify-center gap-2">Abrir App</a>
            </div>
        </div>
    </div>
        <div id="modal-whatsapp" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl space-y-4 animate-fade-in text-center">
            <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-2">
                <i data-lucide="message-circle" class="w-8 h-8"></i>
            </div>
            <h3 class="font-black text-slate-800 uppercase text-lg">WhatsApp Pronto!</h3>
            <p id="wa-numero-display" class="text-xs font-bold text-slate-400 mb-4">Apto --</p>
            <div class="flex gap-3 pt-2">
                <button onclick="document.getElementById('modal-whatsapp').classList.add('hidden')" class="flex-1 py-3 bg-slate-100 text-slate-500 font-black rounded-xl text-xs uppercase">Cancelar</button>
                
                <a id="btn-wa-enviar" href="#" target="_blank" class="flex-1 py-3 bg-emerald-500 text-white font-black rounded-xl text-xs uppercase shadow-lg flex items-center justify-center gap-2">Abrir App</a>
            </div>
        </div>
    </div>
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl space-y-4 animate-fade-in">
            <div class="flex justify-between items-center border-b pb-3">
                <h3 class="font-black text-slate-800 uppercase text-sm">Realizar Entrega</h3>
                <button onclick="closeBaixaModal()" class="text-slate-400 p-2"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4 pt-2">
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <p class="text-[10px] text-blue-600 font-bold uppercase mb-1">Unidade / Morador</p>
                    <p id="baixa-info-morador" class="text-sm font-black text-slate-800">Bloco X - Apto Y</p>
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Quem est√° entregando? (Funcion√°rio)</label>
                    <input id="baixa-entregador" type="text" class="input-field" placeholder="Ex: Porteiro Jo√£o">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Quem est√° retirando? (Morador)</label>
                    <input id="baixa-retirado" type="text" class="input-field" placeholder="Ex: O Pr√≥prio, Esposa, Filho...">
                </div>
            </div>
            <div class="flex gap-3 pt-4">
                <button onclick="closeBaixaModal()" class="flex-1 py-3 bg-slate-100 text-slate-500 font-black rounded-xl text-xs uppercase">Voltar</button>
                <button onclick="confirmarBaixaReal()" class="flex-1 py-3 bg-emerald-600 text-white font-black rounded-xl text-xs uppercase shadow-lg">Confirmar Entrega</button>
            </div>
        </div>
    </div>

    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 no-print">
        <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i data-lucide="package" class="w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">Portaria Control</h1>
            </div>
            
            <div class="flex bg-slate-100 p-1 rounded-xl">
                <button id="tab-p" onclick="switchTab('pendentes')" class="px-3 py-2 text-[10px] font-bold rounded-lg tab-active uppercase transition-all">Portaria</button>
                <button id="tab-m" onclick="switchTab('mensageria')" class="px-3 py-2 text-[10px] font-bold rounded-lg tab-inactive uppercase transition-all">Mensageria</button>
                <button id="tab-h" onclick="switchTab('entregues')" class="px-3 py-2 text-[10px] font-bold rounded-lg tab-inactive uppercase transition-all">Hist√≥rico</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-6 space-y-6">
        
        <div class="grid grid-cols-3 gap-2 no-print">
            <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm text-center">
                <p class="text-[9px] font-bold uppercase text-slate-400 mb-1">Portaria</p>
                <div class="flex items-end justify-center gap-1">
                    <span id="count-p" class="text-2xl font-black text-blue-600">0</span>
                    <span class="text-[8px] text-slate-400 mb-1 font-bold">VOLS</span>
                </div>
            </div>
            <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm text-center">
                <p class="text-[9px] font-bold uppercase text-slate-400 mb-1">Mensageria</p>
                <div class="flex items-end justify-center gap-1">
                    <span id="count-m" class="text-2xl font-black text-orange-500">0</span>
                    <span class="text-[8px] text-slate-400 mb-1 font-bold">UNIDS</span>
                </div>
            </div>
            <div class="bg-white p-3 rounded-2xl border border-slate-200 shadow-sm text-center">
                <p class="text-[9px] font-bold uppercase text-slate-400 mb-1">Hist√≥rico</p>
                <div class="flex items-end justify-center gap-1">
                    <span id="count-e" class="text-2xl font-black text-emerald-600">0</span>
                    <span class="text-[8px] text-slate-400 mb-1 font-bold">UNIDS</span>
                </div>
            </div>
        </div>

        <section id="area-registro" class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm no-print">
            <h2 class="text-[10px] font-black mb-4 flex items-center gap-2 text-slate-400 uppercase tracking-widest">
                <i data-lucide="camera" class="w-4 h-4 text-blue-600"></i> Registro de Encomenda
            </h2>
            <form id="form-main" onsubmit="handleRegistrar(event)" class="space-y-6">
                <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300">
                    <div id="photo-container" class="hidden">
                        <img id="preview-img" src="" class="photo-preview">
                    </div>
                    <div class="flex-1">
                        <label for="input-foto" class="flex flex-col items-center justify-center cursor-pointer py-3 px-4 bg-blue-50 border border-blue-200 text-blue-600 rounded-xl font-bold text-xs uppercase hover:bg-blue-100 transition-all">
                            <i data-lucide="camera" class="w-6 h-6 mb-1"></i>
                            <span>Tirar Foto da Encomenda</span>
                            <input type="file" id="input-foto" accept="image/*" capture="environment" class="hidden" onchange="processarFoto(this)">
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 border-b border-slate-100 pb-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Unidade (Apto)</label>
                        <input id="input-unidade" type="text" placeholder="Ex: 111J" oninput="validarInput(this)" class="input-field uppercase">
                        <p id="feedback-val" class="text-[9px] mt-1 ml-1 font-bold text-slate-400">Pendente</p>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Nome do Morador</label>
                        <input id="input-morador" type="text" placeholder="Morador" class="input-field">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 border-b border-slate-100 pb-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Empresa</label>
                        <input id="input-empresa" type="text" placeholder="Amazon, DHL..." class="input-field">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Remetente</label>
                        <input id="input-remetente" type="text" placeholder="Quem enviou" class="input-field">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 border-b border-slate-100 pb-4">
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Descri√ß√£o</label>
                        <input id="input-descricao" type="text" placeholder="O que √© o produto?" class="input-field">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Volumes</label>
                        <input id="input-qtd" type="number" value="1" min="1" class="input-field text-center">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">NF / Pedido</label>
                        <input id="input-nf" type="text" placeholder="Doc" class="input-field">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Recebedor</label>
                        <input id="input-recebedor" type="text" placeholder="Porteiro" class="input-field">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Portaria at√© as...</label>
                        <input id="input-permanencia" type="text" placeholder="18:00" class="input-field">
                    </div>
                </div>

                <button id="btn-gravar" type="submit" disabled class="w-full bg-blue-600 h-[50px] text-white font-black rounded-2xl active:scale-95 disabled:opacity-50 transition-all uppercase text-xs shadow-lg">
                    Gravar Registro
                </button>
            </form>
        </section>

        <div id="area-acoes" class="flex flex-col gap-3 no-print">
            <div class="relative">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 w-5 h-5"></i>
                <input id="input-busca" type="text" placeholder="Busca por Apto, Morador ou Remetente..." oninput="filtrar(this.value)"
                    class="w-full pl-12 pr-4 py-4 rounded-2xl border border-slate-200 bg-white shadow-sm outline-none font-medium text-sm">
            </div>

            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                <button onclick="setFastFilter('')" id="ff-all" class="whitespace-nowrap px-4 py-2 rounded-xl bg-blue-600 text-white text-[10px] font-bold uppercase transition-all border">Todos</button>
                <button onclick="setFastFilter('J')" id="ff-j" class="whitespace-nowrap px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-500 text-[10px] font-bold uppercase transition-all border">Bloco J</button>
                <button onclick="setFastFilter('P')" id="ff-p" class="whitespace-nowrap px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-500 text-[10px] font-bold uppercase transition-all border">Bloco P</button>
            </div>
            
            <div id="controles-historico" class="hidden flex flex-col gap-2">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportarDados()" class="py-3 bg-white border border-slate-200 text-slate-600 text-[10px] font-bold rounded-xl flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-3 h-3 text-blue-500"></i> Backup JSON
                    </button>
                    <label class="py-3 bg-white border border-slate-200 text-slate-600 text-[10px] font-bold rounded-xl flex items-center justify-center gap-2 cursor-pointer">
                        <i data-lucide="upload" class="w-3 h-3 text-emerald-500"></i> Importar Backup
                        <input type="file" class="hidden" accept=".json" onchange="importarDados(this)">
                    </label>
                </div>
                <button onclick="limparHistorico()" class="w-full py-2 text-red-500 text-[9px] font-black uppercase">Limpar Hist√≥rico do Turno</button>
            </div>
        </div>

        <div id="render-container" class="space-y-4 pb-10"></div>
    </main>

    <script>
        let db = JSON.parse(localStorage.getItem('portaria_v26')) || [];
        let abaAtiva = 'pendentes';
        let termoBusca = '';
        let blocoFiltro = '';
        let currentPhoto = null;
        let expandidoKey = null;
        
        // VARI√ÅVEIS PARA A NOVA MODAL DE BAIXA
        let baixaTargetId = null;
        let baixaTargetOrigem = null;

        function salvar() {
            try {
                localStorage.setItem('portaria_v26', JSON.stringify(db));
                render();
            } catch (e) { alert("Mem√≥ria cheia!"); }
        }

        function processarFoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const max_w = 600;
                        let w = img.width, h = img.height;
                        if (w > max_w) { h *= max_w / w; w = max_w; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext("2d").drawImage(img, 0, 0, w, h);
                        currentPhoto = canvas.toDataURL("image/jpeg", 0.6);
                        document.getElementById('preview-img').src = currentPhoto;
                        document.getElementById('photo-container').classList.remove('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.addPhotoToRecord = (id, input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = 500; canvas.height = (img.height / img.width) * 500;
                        canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
                        const compressed = canvas.toDataURL("image/jpeg", 0.5);
                        const it = db.find(d => d.id === id);
                        if (it) { it.foto = compressed; salvar(); }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function obterFicheiroFoto(base64, nome) {
            if (!base64) return null;
            try {
                const response = await fetch(base64);
                const blob = await response.blob();
                return new File([blob], nome, { type: 'image/jpeg' });
            } catch (e) { return null; }
        }

        window.enviarGrupoCondominio = async (id) => {
            const it = db.find(d => d.id === id);
            if (!it) return;
            const msg = `üì¢ *CONTROLE DE ENCOMENDA - PORTARIA* \n\n` +
                   `üë§ *Morador:* ${it.morador}\n` +
                   `üè¢ *Unidade:* ${it.apto} - Bloco ${it.bloco}\n` +
                   `üì¶ *Produto:* ${it.descricao}\n` +
                   `üöö *Empresa:* ${it.empresa}\n` +
                   `üè∑Ô∏è *Remetente:* ${it.remetente}\n` +
                   `üî¢ *NF/Doc:* ${it.nf}\n` +
                   `üëÆ *Recebido por:* ${it.recebedor}\n` +
                   `‚è∞ *Chegada:* ${it.data} √†s ${it.hora}\n` +
                   `‚è≥ *Portaria at√©:* ${it.permanencia || 'N/A'}`;
            
            const file = await obterFicheiroFoto(it.foto, `encomenda.jpg`);
            if (navigator.share && file) {
                try {
                    await navigator.share({ files: [file], title: 'Controle Portaria', text: msg });
                    return;
                } catch (err) {}
            }
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
        }

        window.enviarAvisoMorador = (id) => {
            const it = db.find(d => d.id === id);
            if (!it) return;
            let permInfo = it.permanencia ? `\n‚ö†Ô∏è *Aten√ß√£o:* Esta encomenda ficar√° na portaria at√© √†s *${it.permanencia}*. Ap√≥s este hor√°rio, ela ser√° encaminhada para a Mensageria.` : '';
            const msg = `Ol√°! üëã Temos uma √≥tima not√≠cia: uma encomenda sua acaba de chegar √† nossa portaria!\n\n` +
                   `üë§ *Para:* ${it.morador}\n` +
                   `üè¢ *Unidade:* ${it.apto} - Bloco ${it.bloco}\n` +
                   `üì¶ *Item:* ${it.descricao}\n` +
                   `üè∑Ô∏è *Remetente:* ${it.remetente}\n` +
                   `üöö *Empresa:* ${it.empresa}\n` +
                   `üî¢ *Doc/NF:* ${it.nf}\n` +
                   `üëÆ *Recebido por:* ${it.recebedor}\n` +
                   `‚è∞ *Registrado em:* ${it.data} √†s ${it.hora}${permInfo}\n\n` +
                   `A portaria √© 24h e voc√™ pode retirar a qualquer momento. At√© j√°! üì¶‚ú®`;
            
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
            it.notificadoPortariaMorador = true; 
            salvar();
        }

        window.enviarAvisoMensageria = (id) => {
            const it = db.find(d => d.id === id);
            if (!it) return;
            const agora = new Date().toLocaleTimeString('pt-PT', {hour:'2-digit', minute:'2-digit'});
            
            const msg = `Ol√°! üëã Informamos que sua encomenda saiu da portaria e chegou √† nossa *MENSAGERIA* e j√° est√° pronta para retirada.\n\n` +
                   `üè¢ *Local:* Unidade ${it.apto} - Bloco ${it.bloco}\n` +
                   `üì¶ *Item:* ${it.descricao}\n` +
                   `‚è∞ *Aviso enviado √†s:* ${agora}\n\n` +
                   `Aguardamos sua visita para a retirada. Tenha um excelente dia! üì¶‚ú®`;
            
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
            it.notificadoMensageria = true;
            salvar();
        }

        window.openEditModal = (id) => {
            const it = db.find(d => d.id === id);
            if (!it) return;
            document.getElementById('edit-id').value = it.id;
            document.getElementById('edit-unidade').value = it.apto + it.bloco;
            document.getElementById('edit-morador').value = it.morador;
            document.getElementById('edit-remetente').value = it.remetente;
            document.getElementById('edit-empresa').value = it.empresa;
            document.getElementById('edit-descricao').value = it.descricao;
            document.getElementById('edit-nf').value = it.nf;
            document.getElementById('edit-recebedor').value = it.recebedor;
            document.getElementById('edit-permanencia').value = it.permanencia || '';
            document.getElementById('edit-tokens').value = (it.tokens || []).join(', ');
            document.getElementById('modal-edit').classList.remove('hidden');
        }

        window.closeEditModal = () => document.getElementById('modal-edit').classList.add('hidden');

        window.saveEdit = () => {
            const id = parseFloat(document.getElementById('edit-id').value);
            const res = validarUnidade(document.getElementById('edit-unidade').value);
            if (!res.ok) { alert(res.msg); return; }
            const idx = db.findIndex(d => d.id === id);
            if (idx !== -1) {
                db[idx].apto = res.apto.toString(); db[idx].bloco = res.bloco;
                db[idx].morador = document.getElementById('edit-morador').value;
                db[idx].remetente = document.getElementById('edit-remetente').value;
                db[idx].empresa = document.getElementById('edit-empresa').value;
                db[idx].descricao = document.getElementById('edit-descricao').value;
                db[idx].nf = document.getElementById('edit-nf').value;
                db[idx].recebedor = document.getElementById('edit-recebedor').value;
                db[idx].permanencia = document.getElementById('edit-permanencia').value;
                const tv = document.getElementById('edit-tokens').value;
                db[idx].tokens = tv ? tv.split(',').map(s => s.trim()).filter(s => s !== '') : [];
                closeEditModal(); salvar();
            }
        }

        // --- L√ìGICA DA NOVA MODAL DE BAIXA ---
        window.openBaixaModal = (id, origem) => {
            const it = db.find(d => d.id === id);
            if (!it) return;
            baixaTargetId = id;
            baixaTargetOrigem = origem;
            
            document.getElementById('baixa-info-morador').innerText = `Bloco ${it.bloco} - Apto ${it.apto} (${it.morador})`;
            document.getElementById('baixa-entregador').value = ""; // Limpa campo
            document.getElementById('baixa-retirado').value = ""; // Limpa campo
            document.getElementById('modal-baixa').classList.remove('hidden');
        }

        window.closeBaixaModal = () => document.getElementById('modal-baixa').classList.add('hidden');

        window.confirmarBaixaReal = () => {
            if (!baixaTargetId) return;
            const idx = db.findIndex(d => d.id === baixaTargetId);
            if (idx !== -1) {
                const entregador = document.getElementById('baixa-entregador').value || "N√£o informado";
                const retiradoPor = document.getElementById('baixa-retirado').value || "O Pr√≥prio";
                
                db[idx].status = 'entregue';
                db[idx].saida = new Date().toISOString();
                db[idx].entreguePor = entregador; // Novo campo
                db[idx].retiradoPor = retiradoPor; // Novo campo
                
                // Define destino baseado na origem da baixa
                if (baixaTargetOrigem === 'mensageria') {
                    db[idx].destino = 'entregue_mensageria';
                } else {
                    db[idx].destino = 'morador';
                }
                
                salvar();
                closeBaixaModal();
            }
        }
        // -------------------------------------

        function validarUnidade(txt) {
            const clean = txt.toUpperCase().replace(/[.\s,;-]/g, '');
            const num = clean.match(/\d+/); const blk = clean.match(/[JP]/);
            if (!num || !blk) return { ok: false, msg: "Bloco?" };
            const n = parseInt(num[0]); const b = blk[0];
            if (n < 11 || n > 181 || n % 10 !== 1) return { ok: false, msg: "Inv√°lida" };
            return { ok: true, apto: n, bloco: b, msg: `‚úì ${b}-${n}` };
        }

        function validarInput(el) {
            const res = validarUnidade(el.value);
            const fb = document.getElementById('feedback-val');
            fb.innerText = res.msg;
            fb.className = `text-[10px] mt-1 font-bold ${res.ok ? 'text-emerald-500' : 'text-red-400'}`;
            document.getElementById('btn-gravar').disabled = !res.ok;
        }

        function handleRegistrar(e) {
            e.preventDefault();
            const res = validarUnidade(document.getElementById('input-unidade').value);
            if (!res.ok) return;
            const now = new Date();
            const nid = Date.now() + Math.random();
            db.push({
                id: nid, apto: res.apto.toString(), bloco: res.bloco,
                morador: document.getElementById('input-morador').value || "Morador",
                empresa: document.getElementById('input-empresa').value || "Empresa",
                remetente: document.getElementById('input-remetente').value || "Remetente",
                descricao: document.getElementById('input-descricao').value || "Volume",
                nf: document.getElementById('input-nf').value || "S/N",
                recebedor: document.getElementById('input-recebedor').value || "Porteiro",
                permanencia: document.getElementById('input-permanencia').value || "",
                qtd: parseInt(document.getElementById('input-qtd').value) || 1,
                foto: currentPhoto, data: now.toLocaleDateString('pt-PT'),
                hora: now.toLocaleTimeString('pt-PT', {hour:'2-digit', minute:'2-digit'}),
                status: 'pendente', tokens: [],
                notificadoPortariaMorador: false, notificadoMensageria: false
            });
            document.getElementById('form-main').reset();
            document.getElementById('photo-container').classList.add('hidden');
            currentPhoto = null;
            salvar();
            enviarGrupoCondominio(nid);
        }

        function switchTab(t) {
            abaAtiva = t; expandidoKey = null; blocoFiltro = '';
            
            const ativo = "bg-white text-blue-600 shadow-sm";
            const inativo = "text-slate-500 hover:bg-slate-200";
            
            document.getElementById('tab-p').className = `px-3 py-2 text-[10px] font-bold rounded-lg uppercase transition-all ${t==='pendentes'?ativo:inativo}`;
            document.getElementById('tab-m').className = `px-3 py-2 text-[10px] font-bold rounded-lg uppercase transition-all ${t==='mensageria'?ativo:inativo}`;
            document.getElementById('tab-h').className = `px-3 py-2 text-[10px] font-bold rounded-lg uppercase transition-all ${t==='entregues'?ativo:inativo}`;

            document.getElementById('area-registro').style.display = t==='pendentes'?'block':'none';
            document.getElementById('controles-historico').style.display = t==='pendentes'?'none':'flex';
            
            render();
        }

        function filtrar(v) { termoBusca = v.toLowerCase().trim(); render(); }
        function setFastFilter(f) { blocoFiltro = f; render(); }
        function toggleExpand(key) { expandidoKey = expandidoKey === key ? null : key; render(); }

        // Fun√ß√£o Antiga Simplificada para apenas Transfer√™ncia Interna
        window.darBaixaDiretaMensageria = (id) => {
             const idx = db.findIndex(d => d.id === id);
            if (idx !== -1) {
                db[idx].status = 'entregue';
                db[idx].saida = new Date().toISOString();
                db[idx].destino = 'mensageria';
                salvar();
            }
        }

        window.excluirUm = (id) => { if(confirm("Apagar?")) { db = db.filter(d => d.id !== id); salvar(); } }
        window.limparHistorico = () => { if(confirm("Limpar todo turno?")) { db = db.filter(d => d.status === 'pendente'); salvar(); } }
        function exportarDados() { const b = new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=`backup.json`; a.click(); }
        function importarDados(input) {
            if(input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => { try { db = JSON.parse(e.target.result); salvar(); } catch(e){alert("Erro!");} };
                r.readAsText(input.files[0]);
            }
        }

        function render() {
            const ac = "bg-blue-600 text-white border-blue-600 shadow-md";
            const inac = "bg-white border-slate-200 text-slate-500";
            document.getElementById('ff-all').className = `whitespace-nowrap px-4 py-2 rounded-xl text-[10px] font-bold uppercase transition-all border ${blocoFiltro===''?ac:inac}`;
            document.getElementById('ff-j').className = `whitespace-nowrap px-4 py-2 rounded-xl text-[10px] font-bold uppercase transition-all border ${blocoFiltro==='J'?ac:inac}`;
            document.getElementById('ff-p').className = `whitespace-nowrap px-4 py-2 rounded-xl text-[10px] font-bold uppercase transition-all border ${blocoFiltro==='P'?ac:inac}`;
            
            let listaBase = [];
            if (abaAtiva === 'pendentes') {
                listaBase = db.filter(d => d.status === 'pendente');
            } else if (abaAtiva === 'mensageria') {
                listaBase = db.filter(d => d.status === 'entregue' && d.destino === 'mensageria');
            } else {
                listaBase = db.filter(d => d.status === 'entregue' && d.destino !== 'mensageria');
            }

            const grupos = {};
            listaBase.forEach(d => {
                const k = `${d.bloco}-${d.apto}`;
                const t = `${d.apto} ${d.bloco} ${d.morador} ${d.remetente} ${d.empresa} ${d.descricao}`.toLowerCase();
                if(termoBusca && !t.includes(termoBusca)) return;
                if(blocoFiltro && d.bloco !== blocoFiltro) return;
                
                if(!grupos[k]) grupos[k] = { b: d.bloco, a: d.apto, itens: [], total: 0, morador: d.morador, statusNotificado: false };
                grupos[k].itens.push(d); grupos[k].total += d.qtd;
                
                if(abaAtiva === 'pendentes' && d.notificadoPortariaMorador) grupos[k].statusNotificado = true;
                if((abaAtiva === 'entregues' || abaAtiva === 'mensageria') && d.notificadoMensageria) grupos[k].statusNotificado = true;
            });

            const filtrados = Object.values(grupos).sort((x,y) => x.b.localeCompare(y.b) || x.a.localeCompare(y.a, undefined, {numeric: true}));
            
            document.getElementById('count-p').innerText = db.filter(d => d.status === 'pendente').reduce((a,b)=>a+b.qtd,0);
            document.getElementById('count-m').innerText = db.filter(d => d.status === 'entregue' && d.destino === 'mensageria').length;
            document.getElementById('count-e').innerText = db.filter(d => d.status === 'entregue' && d.destino !== 'mensageria').length;

            const container = document.getElementById('render-container');
            container.innerHTML = filtrados.length === 0 ? `<div class="p-10 text-center text-slate-400 font-bold text-xs uppercase">Vazio</div>` : '';

            filtrados.forEach(g => {
                const key = `${g.b}-${g.a}`;
                const isExp = expandidoKey === key;
                const card = document.createElement('div');
                card.className = `card-unidade bg-white rounded-2xl border ${abaAtiva==='pendentes'&&g.total>1?'border-orange-200 ring-2 ring-orange-50':'border-slate-100'} shadow-sm overflow-hidden mb-3 animate-fade-in`;
                
                let badgesHist = '';
                if(abaAtiva !== 'pendentes'){
                    let label = 'ENTREGUE (PORTARIA)';
                    let color = 'bg-emerald-100 text-emerald-600';
                    if(g.itens[0].destino === 'mensageria') { label = 'NA MENSAGERIA'; color = 'bg-orange-100 text-orange-600'; }
                    else if (g.itens[0].destino === 'entregue_mensageria') { label = 'ENTREGUE (MENSAGERIA)'; color = 'bg-indigo-100 text-indigo-600'; }
                    badgesHist = `<span class="text-[8px] ${color} font-black px-1.5 py-0.5 rounded uppercase mr-1">${label}</span>`;
                }

                card.innerHTML = `
                    <div onclick="toggleExpand('${key}')" class="p-4 flex items-center gap-3 cursor-pointer active:bg-slate-50">
                        <div class="w-12 h-12 flex items-center justify-center rounded-xl font-bold text-lg ${abaAtiva!=='pendentes'?'bg-slate-100 text-slate-400 border border-dashed':'bg-blue-600 text-white shadow-md'}">${g.b}</div>
                        <div class="flex-1">
                            <h3 class="text-sm font-black text-slate-800 uppercase flex items-center gap-2">
                                Apto ${g.a} - ${g.morador}
                                ${g.statusNotificado ? '<i data-lucide="check-circle-2" class="w-3 h-3 text-emerald-500"></i>' : ''}
                            </h3>
                            <div class="flex gap-1 items-center">
                                ${abaAtiva==='pendentes' ? `<span class="text-[9px] font-bold px-2 py-0.5 rounded-full ${g.total>1?'bg-orange-500 text-white':'bg-slate-100 text-slate-400'} uppercase">${g.total} VOLS</span>` : badgesHist}
                            </div>
                        </div>
                        <i data-lucide="${isExp?'chevron-up':'chevron-down'}" class="text-slate-300"></i>
                    </div>
                    ${isExp ? `<div class="bg-slate-50 border-t border-slate-100 p-4 space-y-4">
                        ${g.itens.map(it => `
                            <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm animate-fade-in relative overflow-hidden">
                                ${((abaAtiva==='pendentes'&&it.notificadoPortariaMorador)||(abaAtiva!=='pendentes'&&it.notificadoMensageria)) ? `<div class="absolute top-0 right-0 bg-emerald-500 text-white px-2 py-0.5 rounded-bl-lg text-[7px] font-black uppercase flex items-center gap-1 shadow-sm"><i data-lucide="check" class="w-2 h-2"></i> Mensagem Enviada</div>` : ''}
                                
                                <div class="flex gap-4 mb-4">
                                    <div class="relative">
                                        ${it.foto ? `<img src="${it.foto}" class="w-20 h-20 rounded-lg object-cover border border-slate-200" onclick="window.open(this.src)">` : `
                                            <label class="w-20 h-20 bg-slate-100 rounded-lg flex flex-col items-center justify-center text-blue-500 cursor-pointer no-print">
                                                <i data-lucide="camera" class="w-5 h-5"></i><span class="text-[7px] font-black text-center">FOTO</span>
                                                <input type="file" accept="image/*" capture="environment" class="hidden" onchange="addPhotoToRecord(${it.id}, this)">
                                            </label>`}
                                    </div>
                                    <div class="flex-1 space-y-1">
                                        <div class="flex justify-between items-start">
                                            <div><p class="text-[8px] font-black text-slate-400 uppercase">Remetente</p><p class="text-[11px] font-black text-blue-700 uppercase">${it.remetente}</p></div>
                                            <div class="flex gap-2 no-print">
                                                ${abaAtiva === 'pendentes' ? `
                                                    <button onclick="enviarGrupoCondominio(${it.id})" class="p-1.5 text-white bg-emerald-500 rounded-lg shadow-sm" title="Grupo Administrativo"><i data-lucide="send" class="w-4 h-4"></i></button>
                                                    <button onclick="enviarAvisoMorador(${it.id})" class="p-1.5 text-white bg-blue-500 rounded-lg shadow-sm" title="Avisar Morador"><i data-lucide="bell" class="w-4 h-4"></i></button>
                                                ` : `
                                                    ${it.destino === 'mensageria' ? `<button onclick="enviarAvisoMensageria(${it.id})" class="p-1.5 text-white bg-emerald-500 rounded-lg shadow-sm" title="Aviso Mensageria"><i data-lucide="send" class="w-4 h-4"></i></button>` : ''}
                                                `}
                                                <button onclick="openEditModal(${it.id})" class="p-1.5 text-blue-400 bg-blue-50 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                                <button onclick="excluirUm(${it.id})" class="p-1.5 text-red-400 bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </div>
                                        </div>
                                        <p class="text-[10px] font-bold text-slate-700 uppercase">${it.empresa}</p>
                                        <p class="text-[10px] italic text-slate-600 mt-1">${it.descricao}</p>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-x-2 gap-y-3 border-t pt-2 text-[9px] font-black uppercase text-slate-400">
                                    <div><p class="text-[7px]">Doc / NF</p><p class="text-slate-700">${it.nf}</p></div>
                                    <div><p class="text-[7px]">Recebedor</p><p class="text-slate-700">${it.recebedor}</p></div>
                                    <div><p class="text-[7px]">Entrada</p><p class="text-slate-700">${it.data} √†s ${it.hora}</p></div>
                                    <div><p class="text-[7px] text-blue-500">Portaria at√©:</p><p class="text-blue-600 font-bold">${it.permanencia || 'N/A'}</p></div>
                                    ${it.saida ? `<div class="col-span-2 border-t pt-1"><p class="text-[7px] text-emerald-500 font-black uppercase">Sa√≠da: ${new Date(it.saida).toLocaleString('pt-PT')} (${it.destino})</p>
                                    ${it.entreguePor ? `<p class="text-[7px] text-slate-500 mt-0.5 font-medium">Entregue por: ${it.entreguePor} | Retirado por: ${it.retiradoPor}</p>` : ''}
                                    </div>` : ''}
                                </div>
                                ${abaAtiva === 'pendentes' ? `
                                    <div class="mt-4 pt-3 border-t space-y-2 no-print">
                                        <div class="grid grid-cols-2 gap-2">
                                            <button onclick="openBaixaModal(${it.id}, 'portaria')" class="bg-emerald-600 text-white py-3 rounded-xl font-black text-[9px] uppercase shadow-sm">Entrega Morador</button>
                                            <button onclick="darBaixaDiretaMensageria(${it.id})" class="bg-blue-600 text-white py-3 rounded-xl font-black text-[9px] uppercase shadow-sm">Encaminhar Mensageria</button>
                                        </div>
                                    </div>` : ''}
                                
                                ${abaAtiva === 'mensageria' ? `
                                    <div class="mt-4 pt-3 border-t space-y-2 no-print">
                                        <button onclick="openBaixaModal(${it.id}, 'mensageria')" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-black text-[9px] uppercase shadow-sm active:scale-95 transition-all">Confirmar Entrega ao Morador</button>
                                    </div>` : ''}
                            </div>
                        `).join('')}
                    </div>` : ''}
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }
        window.onload = () => render();
    </script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAd3RY1xWBfJJwNNHTbUB50xXPkcB-2b08",
    authDomain: "trackeasy-669e3.firebaseapp.com",
    projectId: "trackeasy-669e3",
    storageBucket: "trackeasy-669e3.firebasestorage.app",
    messagingSenderId: "656055712426",
    appId: "1:656055712426:web:c393bdb7ccf0afe820eed3"
  };

  const app = initializeApp(firebaseConfig);
  const dbFirebase = getFirestore(app);
  const encomendasRef = collection(dbFirebase, "encomendas");

  // VARI√ÅVEIS GLOBAIS
  window.db = []; 
  window.abaAtiva = 'pendentes'; window.termoBusca = ''; window.blocoFiltro = '';
  window.currentPhoto = null; window.expandidoKey = null;
  window.baixaTargetId = null; window.baixaTargetOrigem = null;

  // 1. O CORA√á√ÉO: Lendo da Nuvem em Tempo Real!
  onSnapshot(encomendasRef, (snapshot) => {
    window.db = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
    window.render(); // Atualiza a tela sozinho sempre que chegar encomenda nova!
  });

  // Fun√ß√£o ajudante para achar o ID da nuvem
  function getFbId(localId) {
    const item = window.db.find(d => d.id === localId);
    return item ? item.firebaseId : null;
  }

  // 2. REGISTRAR ENCOMENDA (Salva direto no Firebase)
  window.handleRegistrar = async (e) => {
    e.preventDefault();
    const res = window.validarUnidade(document.getElementById('input-unidade').value);
    if (!res.ok) return;
    
    const now = new Date();
    const novoRegistro = {
        id: Date.now() + Math.random(), // ID interno de seguran√ßa
        apto: res.apto.toString(), bloco: res.bloco,
        morador: document.getElementById('input-morador').value || "Morador",
        empresa: document.getElementById('input-empresa').value || "Empresa",
        remetente: document.getElementById('input-remetente').value || "Remetente",
        descricao: document.getElementById('input-descricao').value || "Volume",
        nf: document.getElementById('input-nf').value || "S/N",
        recebedor: document.getElementById('input-recebedor').value || "Porteiro",
        permanencia: document.getElementById('input-permanencia').value || "",
        qtd: parseInt(document.getElementById('input-qtd').value) || 1,
        foto: window.currentPhoto, 
        data: now.toLocaleDateString('pt-PT'),
        hora: now.toLocaleTimeString('pt-PT', {hour:'2-digit', minute:'2-digit'}),
        status: 'pendente', tokens: [],
        notificadoPortariaMorador: false, notificadoMensageria: false
    };

    try {
        document.getElementById('btn-gravar').innerText = "Salvando na Nuvem...";
        await addDoc(encomendasRef, novoRegistro);
        
        document.getElementById('form-main').reset();
        document.getElementById('photo-container').classList.add('hidden');
        window.currentPhoto = null;
        document.getElementById('btn-gravar').innerText = "Gravar Registro";
        document.getElementById('btn-gravar').disabled = true;
        document.getElementById('feedback-val').innerText = "Pendente";
    } catch(err) { alert("Erro ao salvar!"); console.error(err); }
  };

  // 3. ATUALIZA√á√ïES E BAIXAS (Edita o documento no Firebase)
  window.saveEdit = async () => {
    const id = parseFloat(document.getElementById('edit-id').value);
    const fbId = getFbId(id);
    if(!fbId) return;

    const res = window.validarUnidade(document.getElementById('edit-unidade').value);
    if (!res.ok) { alert(res.msg); return; }

    const tv = document.getElementById('edit-tokens').value;
    const tokensArray = tv ? tv.split(',').map(s => s.trim()).filter(s => s !== '') : [];

    await updateDoc(doc(dbFirebase, "encomendas", fbId), {
        apto: res.apto.toString(), bloco: res.bloco,
        morador: document.getElementById('edit-morador').value,
        remetente: document.getElementById('edit-remetente').value,
        empresa: document.getElementById('edit-empresa').value,
        descricao: document.getElementById('edit-descricao').value,
        nf: document.getElementById('edit-nf').value,
        recebedor: document.getElementById('edit-recebedor').value,
        permanencia: document.getElementById('edit-permanencia').value,
        tokens: tokensArray
    });
    window.closeEditModal();
  };

  window.confirmarBaixaReal = async () => {
    const fbId = getFbId(window.baixaTargetId);
    if (!fbId) return;
    
    const entregador = document.getElementById('baixa-entregador').value || "N√£o informado";
    const retiradoPor = document.getElementById('baixa-retirado').value || "O Pr√≥prio";
    let destinoFinal = window.baixaTargetOrigem === 'mensageria' ? 'entregue_mensageria' : 'morador';

    await updateDoc(doc(dbFirebase, "encomendas", fbId), {
        status: 'entregue', saida: new Date().toISOString(),
        entreguePor: entregador, retiradoPor: retiradoPor, destino: destinoFinal
    });
    window.closeBaixaModal();
  };

  window.darBaixaDiretaMensageria = async (id) => {
    const fbId = getFbId(id);
    if(fbId) await updateDoc(doc(dbFirebase, "encomendas", fbId), { status: 'entregue', saida: new Date().toISOString(), destino: 'mensageria' });
  };

  window.excluirUm = async (id) => {
    if(confirm("Apagar da nuvem permanentemente?")) {
        const fbId = getFbId(id);
        if(fbId) await deleteDoc(doc(dbFirebase, "encomendas", fbId));
    }
  };

  window.limparHistorico = () => { 
    if(confirm("Limpar todo o hist√≥rico do turno na nuvem?")) { 
        window.db.forEach(async d => {
            if(d.status !== 'pendente') await deleteDoc(doc(dbFirebase, "encomendas", d.firebaseId));
        });
    } 
  };

  // 4. INTEGRA√á√ÉO COM WHATSAPP (A Janelinha Anti-Bloqueio)
  window.enviarWhatsFirebase = async function(id, tipoAviso) {
    const it = window.db.find(d => d.id === id);
    if (!it) return;
    const idFirebase = (it.apto + it.bloco).toUpperCase();

    try {
      const docRef = doc(dbFirebase, "moradores", idFirebase);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const dados = docSnap.data();
        let numeroWhats = String(dados.whatsapp1).replace(/\D/g, ''); 
        if (numeroWhats.length <= 11) numeroWhats = '55' + numeroWhats;

        let msg = "";
        if (tipoAviso === 'portaria') {
          let permInfo = it.permanencia ? `\n‚ö†Ô∏è *Aten√ß√£o:* Esta encomenda ficar√° na portaria at√© √†s *${it.permanencia}*. Ap√≥s este hor√°rio, ela ser√° encaminhada para a Mensageria.` : '';
          msg = `Ol√°! üëã Temos uma √≥tima not√≠cia: uma encomenda sua acaba de chegar √† nossa portaria!\n\nüë§ *Para:* ${it.morador}\nüè¢ *Unidade:* ${it.apto} - Bloco ${it.bloco}\nüì¶ *Item:* ${it.descricao}\nüè∑Ô∏è *Remetente:* ${it.remetente}\nüöö *Empresa:* ${it.empresa}\nüî¢ *Doc/NF:* ${it.nf}\nüëÆ *Recebido por:* ${it.recebedor}\n‚è∞ *Registrado em:* ${it.data} √†s ${it.hora}${permInfo}\n\nA portaria √© 24h e voc√™ pode retirar a qualquer momento. At√© j√°! üì¶‚ú®`;
        } else {
          const agora = new Date().toLocaleTimeString('pt-PT', {hour:'2-digit', minute:'2-digit'});
          msg = `Ol√°! üëã Informamos que sua encomenda saiu da portaria e chegou √† nossa *MENSAGERIA* e j√° est√° pronta para retirada.\n\nüè¢ *Local:* Unidade ${it.apto} - Bloco ${it.bloco}\nüì¶ *Item:* ${it.descricao}\n‚è∞ *Aviso enviado √†s:* ${agora}\n\nAguardamos sua visita para a retirada. Tenha um excelente dia! üì¶‚ú®`;
        }
        
        const linkFinal = `https://wa.me/${numeroWhats}?text=${encodeURIComponent(msg)}`;
        
        document.getElementById('wa-numero-display').innerText = `Apto: ${idFirebase} | N¬∫: +${numeroWhats}`;
        const btnEnviar = document.getElementById('btn-wa-enviar');
        btnEnviar.href = linkFinal; 
        
        // Quando confirmar o envio, registra na nuvem que foi notificado
        btnEnviar.onclick = async () => {
          const fbId = getFbId(id);
          if (fbId) {
              if (tipoAviso === 'portaria') await updateDoc(doc(dbFirebase, "encomendas", fbId), { notificadoPortariaMorador: true });
              else await updateDoc(doc(dbFirebase, "encomendas", fbId), { notificadoMensageria: true });
          }
          document.getElementById('modal-whatsapp').classList.add('hidden');
        };

        document.getElementById('modal-whatsapp').classList.remove('hidden');

      } else {
        alert(`‚ùå O apartamento ${idFirebase} ainda n√£o tem n√∫mero salvo no banco de dados!`);
      }
    } catch (error) {
      console.error("Erro Firebase:", error);
      alert("Erro de conex√£o com o banco de dados.");
    }
  };

  window.enviarAvisoMorador = (id) => window.enviarWhatsFirebase(id, 'portaria');
  window.enviarAvisoMensageria = (id) => window.enviarWhatsFirebase(id, 'mensageria');

  // FUN√á√ïES VISUAIS DA INTERFACE (Mantecidas id√™nticas, apenas conectadas ao window)
  window.processarFoto = function(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                if (w > 600) { h *= 600 / w; w = 600; }
                canvas.width = w; canvas.height = h;
                canvas.getContext("2d").drawImage(img, 0, 0, w, h);
                window.currentPhoto = canvas.toDataURL("image/jpeg", 0.6);
                document.getElementById('preview-img').src = window.currentPhoto;
                document.getElementById('photo-container').classList.remove('hidden');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }
  };

  window.validarUnidade = function(txt) {
    const clean = txt.toUpperCase().replace(/[.\s,;-]/g, '');
    const num = clean.match(/\d+/); const blk = clean.match(/[JP]/);
    if (!num || !blk) return { ok: false, msg: "Bloco?" };
    const n = parseInt(num[0]); const b = blk[0];
    if (n < 11 || n > 181 || n % 10 !== 1) return { ok: false, msg: "Inv√°lida" };
    return { ok: true, apto: n, bloco: b, msg: `‚úì ${b}-${n}` };
  };

  window.validarInput = function(el) {
    const res = window.validarUnidade(el.value);
    const fb = document.getElementById('feedback-val');
    fb.innerText = res.msg;
    fb.className = `text-[10px] mt-1 font-bold ${res.ok ? 'text-emerald-500' : 'text-red-400'}`;
    document.getElementById('btn-gravar').disabled = !res.ok;
  };

  window.switchTab = function(t) {
    window.abaAtiva = t; window.expandidoKey = null; window.blocoFiltro = '';
    const ativo = "bg-white text-blue-600 shadow-sm";
    const inativo = "text-slate-500 hover:bg-slate-200";
    document.getElementById('tab-p').className = `px-3 py-2 text-[10px] font-bold rounded-lg uppercase transition-all ${t==='pendentes'?ativo:inativo}`;
    document.getElementById('tab-m').className = `px-3 py-2 text-[10px] font-bold rounded-lg uppercase transition-all ${t==='mensageria'?ativo:inativo}`;
    document.getElementById('tab-h').className = `px-3 py-2 text-[10px] font-bold rounded-lg uppercase transition-all ${t==='entregues'?ativo:inativo}`;
    document.getElementById('area-registro').style.display = t==='pendentes'?'block':'none';
    document.getElementById('controles-historico').style.display = t==='pendentes'?'none':'flex';
    window.render();
  };

  window.filtrar = function(v) { window.termoBusca = v.toLowerCase().trim(); window.render(); };
  window.setFastFilter = function(f) { window.blocoFiltro = f; window.render(); };
  window.toggleExpand = function(key) { window.expandidoKey = window.expandidoKey === key ? null : key; window.render(); };
  
  window.openEditModal = (id) => {
    const it = window.db.find(d => d.id === id);
    if (!it) return;
    document.getElementById('edit-id').value = it.id;
    document.getElementById('edit-unidade').value = it.apto + it.bloco;
    document.getElementById('edit-morador').value = it.morador;
    document.getElementById('edit-remetente').value = it.remetente;
    document.getElementById('edit-empresa').value = it.empresa;
    document.getElementById('edit-descricao').value = it.descricao;
    document.getElementById('edit-nf').value = it.nf;
    document.getElementById('edit-recebedor').value = it.recebedor;
    document.getElementById('edit-permanencia').value = it.permanencia || '';
    document.getElementById('edit-tokens').value = (it.tokens || []).join(', ');
    document.getElementById('modal-edit').classList.remove('hidden');
  };
  window.closeEditModal = () => document.getElementById('modal-edit').classList.add('hidden');
  
  window.openBaixaModal = (id, origem) => {
    const it = window.db.find(d => d.id === id);
    if (!it) return;
    window.baixaTargetId = id; window.baixaTargetOrigem = origem;
    document.getElementById('baixa-info-morador').innerText = `Bloco ${it.bloco} - Apto ${it.apto} (${it.morador})`;
    document.getElementById('baixa-entregador').value = "";
    document.getElementById('baixa-retirado').value = "";
    document.getElementById('modal-baixa').classList.remove('hidden');
  };
  window.closeBaixaModal = () => document.getElementById('modal-baixa').classList.add('hidden');

  // FUN√á√ÉO ORIGINAL DE RENDERIZA√á√ÉO (Apenas conectada a Nuvem)
  window.render = function() {
    const ac = "bg-blue-600 text-white border-blue-600 shadow-md";
    const inac = "bg-white border-slate-200 text-slate-500";
    document.getElementById('ff-all').className = `whitespace-nowrap px-4 py-2 rounded-xl text-[10px] font-bold uppercase transition-all border ${window.blocoFiltro===''?ac:inac}`;
    document.getElementById('ff-j').className = `whitespace-nowrap px-4 py-2 rounded-xl text-[10px] font-bold uppercase transition-all border ${window.blocoFiltro==='J'?ac:inac}`;
    document.getElementById('ff-p').className = `whitespace-nowrap px-4 py-2 rounded-xl text-[10px] font-bold uppercase transition-all border ${window.blocoFiltro==='P'?ac:inac}`;
    
    let listaBase = [];
    if (window.abaAtiva === 'pendentes') listaBase = window.db.filter(d => d.status === 'pendente');
    else if (window.abaAtiva === 'mensageria') listaBase = window.db.filter(d => d.status === 'entregue' && d.destino === 'mensageria');
    else listaBase = window.db.filter(d => d.status === 'entregue' && d.destino !== 'mensageria');

    const grupos = {};
    listaBase.forEach(d => {
        const k = `${d.bloco}-${d.apto}`;
        const t = `${d.apto} ${d.bloco} ${d.morador} ${d.remetente} ${d.empresa} ${d.descricao}`.toLowerCase();
        if(window.termoBusca && !t.includes(window.termoBusca)) return;
        if(window.blocoFiltro && d.bloco !== window.blocoFiltro) return;
        if(!grupos[k]) grupos[k] = { b: d.bloco, a: d.apto, itens: [], total: 0, morador: d.morador, statusNotificado: false };
        grupos[k].itens.push(d); grupos[k].total += d.qtd;
        if(window.abaAtiva === 'pendentes' && d.notificadoPortariaMorador) grupos[k].statusNotificado = true;
        if((window.abaAtiva === 'entregues' || window.abaAtiva === 'mensageria') && d.notificadoMensageria) grupos[k].statusNotificado = true;
    });

    const filtrados = Object.values(grupos).sort((x,y) => x.b.localeCompare(y.b) || x.a.localeCompare(y.a, undefined, {numeric: true}));
    
    document.getElementById('count-p').innerText = window.db.filter(d => d.status === 'pendente').reduce((a,b)=>a+b.qtd,0);
    document.getElementById('count-m').innerText = window.db.filter(d => d.status === 'entregue' && d.destino === 'mensageria').length;
    document.getElementById('count-e').innerText = window.db.filter(d => d.status === 'entregue' && d.destino !== 'mensageria').length;

    const container = document.getElementById('render-container');
    container.innerHTML = filtrados.length === 0 ? `<div class="p-10 text-center text-slate-400 font-bold text-xs uppercase">Vazio</div>` : '';

    filtrados.forEach(g => {
        const key = `${g.b}-${g.a}`; const isExp = window.expandidoKey === key;
        const card = document.createElement('div');
        card.className = `card-unidade bg-white rounded-2xl border ${window.abaAtiva==='pendentes'&&g.total>1?'border-orange-200 ring-2 ring-orange-50':'border-slate-100'} shadow-sm overflow-hidden mb-3 animate-fade-in`;
        
        let badgesHist = '';
        if(window.abaAtiva !== 'pendentes'){
            let label = 'ENTREGUE (PORTARIA)'; let color = 'bg-emerald-100 text-emerald-600';
            if(g.itens[0].destino === 'mensageria') { label = 'NA MENSAGERIA'; color = 'bg-orange-100 text-orange-600'; }
            else if (g.itens[0].destino === 'entregue_mensageria') { label = 'ENTREGUE (MENSAGERIA)'; color = 'bg-indigo-100 text-indigo-600'; }
            badgesHist = `<span class="text-[8px] ${color} font-black px-1.5 py-0.5 rounded uppercase mr-1">${label}</span>`;
        }

        card.innerHTML = `
            <div onclick="toggleExpand('${key}')" class="p-4 flex items-center gap-3 cursor-pointer active:bg-slate-50">
                <div class="w-12 h-12 flex items-center justify-center rounded-xl font-bold text-lg ${window.abaAtiva!=='pendentes'?'bg-slate-100 text-slate-400 border border-dashed':'bg-blue-600 text-white shadow-md'}">${g.b}</div>
                <div class="flex-1">
                    <h3 class="text-sm font-black text-slate-800 uppercase flex items-center gap-2">Apto ${g.a} - ${g.morador} ${g.statusNotificado ? '<i data-lucide="check-circle-2" class="w-3 h-3 text-emerald-500"></i>' : ''}</h3>
                    <div class="flex gap-1 items-center">${window.abaAtiva==='pendentes' ? `<span class="text-[9px] font-bold px-2 py-0.5 rounded-full ${g.total>1?'bg-orange-500 text-white':'bg-slate-100 text-slate-400'} uppercase">${g.total} VOLS</span>` : badgesHist}</div>
                </div>
                <i data-lucide="${isExp?'chevron-up':'chevron-down'}" class="text-slate-300"></i>
            </div>
            ${isExp ? `<div class="bg-slate-50 border-t border-slate-100 p-4 space-y-4">
                ${g.itens.map(it => `
                    <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm animate-fade-in relative overflow-hidden">
                        ${((window.abaAtiva==='pendentes'&&it.notificadoPortariaMorador)||(window.abaAtiva!=='pendentes'&&it.notificadoMensageria)) ? `<div class="absolute top-0 right-0 bg-emerald-500 text-white px-2 py-0.5 rounded-bl-lg text-[7px] font-black uppercase flex items-center gap-1 shadow-sm"><i data-lucide="check" class="w-2 h-2"></i> Mensagem Enviada</div>` : ''}
                        <div class="flex gap-4 mb-4">
                            <div class="relative">${it.foto ? `<img src="${it.foto}" class="w-20 h-20 rounded-lg object-cover border border-slate-200" onclick="window.open(this.src)">` : `<div class="w-20 h-20 bg-slate-100 rounded-lg flex flex-col items-center justify-center text-slate-400"><i data-lucide="image" class="w-5 h-5"></i></div>`}</div>
                            <div class="flex-1 space-y-1">
                                <div class="flex justify-between items-start">
                                    <div><p class="text-[8px] font-black text-slate-400 uppercase">Remetente</p><p class="text-[11px] font-black text-blue-700 uppercase">${it.remetente}</p></div>
                                    <div class="flex gap-2 no-print">
                                        ${window.abaAtiva === 'pendentes' ? `<button onclick="enviarAvisoMorador(${it.id})" class="p-1.5 text-white bg-blue-500 rounded-lg shadow-sm" title="Avisar Morador"><i data-lucide="bell" class="w-4 h-4"></i></button>` : `${it.destino === 'mensageria' ? `<button onclick="enviarAvisoMensageria(${it.id})" class="p-1.5 text-white bg-emerald-500 rounded-lg shadow-sm" title="Aviso Mensageria"><i data-lucide="send" class="w-4 h-4"></i></button>` : ''}`}
                                        <button onclick="openEditModal(${it.id})" class="p-1.5 text-blue-400 bg-blue-50 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                        <button onclick="excluirUm(${it.id})" class="p-1.5 text-red-400 bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                <p class="text-[10px] font-bold text-slate-700 uppercase">${it.empresa}</p>
                                <p class="text-[10px] italic text-slate-600 mt-1">${it.descricao}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-x-2 gap-y-3 border-t pt-2 text-[9px] font-black uppercase text-slate-400">
                            <div><p class="text-[7px]">Doc / NF</p><p class="text-slate-700">${it.nf}</p></div>
                            <div><p class="text-[7px]">Recebedor</p><p class="text-slate-700">${it.recebedor}</p></div>
                            <div><p class="text-[7px]">Entrada</p><p class="text-slate-700">${it.data} √†s ${it.hora}</p></div>
                            <div><p class="text-[7px] text-blue-500">Portaria at√©:</p><p class="text-blue-600 font-bold">${it.permanencia || 'N/A'}</p></div>
                            ${it.saida ? `<div class="col-span-2 border-t pt-1"><p class="text-[7px] text-emerald-500 font-black uppercase">Sa√≠da: ${new Date(it.saida).toLocaleString('pt-PT')} (${it.destino})</p>${it.entreguePor ? `<p class="text-[7px] text-slate-500 mt-0.5 font-medium">Entregue por: ${it.entreguePor} | Retirado por: ${it.retiradoPor}</p>` : ''}</div>` : ''}
                        </div>
                        ${window.abaAtiva === 'pendentes' ? `<div class="mt-4 pt-3 border-t space-y-2 no-print"><div class="grid grid-cols-2 gap-2"><button onclick="openBaixaModal(${it.id}, 'portaria')" class="bg-emerald-600 text-white py-3 rounded-xl font-black text-[9px] uppercase shadow-sm">Entrega Morador</button><button onclick="darBaixaDiretaMensageria(${it.id})" class="bg-blue-600 text-white py-3 rounded-xl font-black text-[9px] uppercase shadow-sm">Encaminhar Mensageria</button></div></div>` : ''}
                        ${window.abaAtiva === 'mensageria' ? `<div class="mt-4 pt-3 border-t space-y-2 no-print"><button onclick="openBaixaModal(${it.id}, 'mensageria')" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-black text-[9px] uppercase shadow-sm active:scale-95 transition-all">Confirmar Entrega ao Morador</button></div>` : ''}
                    </div>
                `).join('')}
            </div>` : ''}
        `;
        container.appendChild(card);
    });
    if (typeof lucide !== 'undefined') lucide.createIcons();
  };
</script>
</body>
</html>











