<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> TrackEasy </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        .tab-active { background-color: white; color: #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-inactive { color: #64748b; }
        .animate-fade-in { animation: fadeIn 0.15s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        
        .input-field { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background-color: #f8fafc; font-weight: 600; font-size: 13px; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #2563eb; ring: 2px; ring-color: #2563eb; background-color: #fff; }

        .photo-preview { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; border: 2px solid #2563eb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .modal-overlay { background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }

        @media print {
            header, #area-registro, #area-acoes, .no-print, .btn-acao, input, .filters-container { display: none !important; }
            body { background: white; padding: 0; }
            .card-unidade { border: 1px solid #eee !important; break-inside: avoid; margin-bottom: 10px; border-radius: 8px !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-10">

    <div id="modal-edit" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-lg rounded-3xl p-6 shadow-2xl space-y-4 max-h-[90vh] overflow-y-auto animate-fade-in">
            <div class="flex justify-between items-center border-b pb-3">
                <h3 class="font-black text-slate-800 uppercase text-sm">Corre√ß√£o de Dados</h3>
                <button onclick="closeEditModal()" class="text-slate-400 p-2"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4 pt-2">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Unidade</label>
                        <input id="edit-unidade" type="text" class="input-field uppercase">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Morador</label>
                        <input id="edit-morador" type="text" class="input-field">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Remetente</label>
                        <input id="edit-remetente" type="text" class="input-field">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Empresa</label>
                        <input id="edit-empresa" type="text" class="input-field">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Descri√ß√£o do Produto</label>
                    <input id="edit-descricao" type="text" class="input-field">
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">NF / Pedido</label>
                        <input id="edit-nf" type="text" class="input-field">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Recebedor</label>
                        <input id="edit-recebedor" type="text" class="input-field">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Portaria at√©</label>
                        <input id="edit-permanencia" type="text" class="input-field" placeholder="Ex: 18:00">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Token / C√≥digo de Sa√≠da</label>
                    <input id="edit-tokens" type="text" class="input-field" placeholder="Ex: 1234">
                </div>
            </div>
            <div class="flex gap-3 pt-4">
                <button onclick="closeEditModal()" class="flex-1 py-3 bg-slate-100 text-slate-500 font-black rounded-xl text-xs uppercase">Cancelar</button>
                <button onclick="saveEdit()" class="flex-1 py-3 bg-blue-600 text-white font-black rounded-xl text-xs uppercase shadow-lg">Salvar</button>
            </div>
        </div>
    </div>

  <div id="modal-baixa" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl space-y-4 animate-fade-in">
            <div class="flex justify-between items-center border-b pb-3">
                <h3 class="font-black text-slate-800 uppercase text-sm">Realizar Entrega</h3>
                <button onclick="window.closeBaixaModal()" class="text-slate-400 p-2"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-4 pt-2">
                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <p class="text-[10px] text-blue-600 font-bold uppercase mb-1">Unidade / Morador</p>
                    <p id="baixa-info-morador" class="text-sm font-black text-slate-800">Bloco X - Apto Y</p>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Quem est√° entregando? (Funcion√°rio)</label>
                    <input id="baixa-entregador" type="text" class="input-field" placeholder="Ex: Porteiro Jo√£o">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">Quem est√° retirando? (Morador)</label>
                    <input id="baixa-retirado" type="text" class="input-field" placeholder="Ex: O Pr√≥prio, Esposa, Filho...">
                </div>
            </div>
            <div class="flex gap-3 pt-4">
                <button onclick="window.closeBaixaModal()" class="flex-1 py-3 bg-slate-100 text-slate-500 font-black rounded-xl text-xs uppercase">Voltar</button>
                <button onclick="window.confirmarBaixaReal()" class="flex-1 py-3 bg-emerald-600 text-white font-black rounded-xl text-xs uppercase shadow-lg">Confirmar Entrega</button>
            </div>
        </div>
    </div>

    <div id="modal-whatsapp" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl space-y-4 animate-fade-in text-center">
            <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-2">
                <i data-lucide="message-circle" class="w-8 h-8"></i>
            </div>
            <h3 class="font-black text-slate-800 uppercase text-lg">WhatsApp Pronto!</h3>
            <p id="wa-numero-display" class="text-xs font-bold text-slate-400 mb-4">Apto --</p>
            <div class="flex gap-3 pt-2">
                <button onclick="document.getElementById('modal-whatsapp').classList.add('hidden')" class="flex-1 py-3 bg-slate-100 text-slate-500 font-black rounded-xl text-xs uppercase">Cancelar</button>
                <a id="btn-wa-enviar" href="#" target="_blank" class="flex-1 py-3 bg-blue-600 text-white font-black rounded-xl text-xs uppercase shadow-lg flex items-center justify-center gap-2">Abrir WhatsApp</a>
            </div>
        </div>
    </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAd3RY1xWBfJJwNNHTbUB50xXPkcB-2b08",
    authDomain: "trackeasy-669e3.firebaseapp.com",
    projectId: "trackeasy-669e3",
    storageBucket: "trackeasy-669e3.firebasestorage.app",
    messagingSenderId: "656055712426",
    appId: "1:656055712426:web:c393bdb7ccf0afe820eed3"
  };

  const app = initializeApp(firebaseConfig);
  const dbFirebase = getFirestore(app);
  const encomendasRef = collection(dbFirebase, "encomendas");

  // VARI√ÅVEIS GLOBAIS
  window.db = []; 
  window.abaAtiva = 'pendentes'; window.termoBusca = ''; window.blocoFiltro = '';
  window.currentPhoto = null; window.expandidoKey = null;
  window.baixaTargetId = null; window.baixaTargetOrigem = null;

  // 1. ESCUTA DA NUVEM
  onSnapshot(encomendasRef, (snapshot) => {
    window.db = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
    window.render();
  });

  function getFbId(localId) {
    const item = window.db.find(d => d.id === localId);
    return item ? item.firebaseId : null;
  }

  // 2. REGISTRAR E COMPARTILHAR AUTOM√ÅTICO
  window.handleRegistrar = async (e) => {
    e.preventDefault();
    const res = window.validarUnidade(document.getElementById('input-unidade').value);
    if (!res.ok) return;
    
    const now = new Date();
    const novoRegistro = {
        id: Date.now() + Math.random(),
        apto: res.apto.toString(), bloco: res.bloco,
        morador: document.getElementById('input-morador').value || "Morador",
        empresa: document.getElementById('input-empresa').value || "Empresa",
        remetente: document.getElementById('input-remetente').value || "Remetente",
        descricao: document.getElementById('input-descricao').value || "Volume",
        nf: document.getElementById('input-nf').value || "S/N",
        recebedor: document.getElementById('input-recebedor').value || "Porteiro",
        permanencia: document.getElementById('input-permanencia').value || "",
        qtd: parseInt(document.getElementById('input-qtd').value) || 1,
        foto: window.currentPhoto, 
        data: now.toLocaleDateString('pt-PT'),
        hora: now.toLocaleTimeString('pt-PT', {hour:'2-digit', minute:'2-digit'}),
        status: 'pendente', tokens: [],
        notificadoPortariaMorador: false, notificadoMensageria: false
    };

    try {
        await addDoc(encomendasRef, novoRegistro);
        document.getElementById('form-main').reset();
        document.getElementById('photo-container').classList.add('hidden');
        window.currentPhoto = null;
        document.getElementById('btn-gravar').disabled = true;
        document.getElementById('feedback-val').innerText = "Pendente";
        
        // DISPARO PARA ADM
        window.enviarGrupoCondominioPorObjeto(novoRegistro);
    } catch(err) { alert("Erro ao salvar!"); }
  };

  // 3. FUN√á√ÉO COMPARTILHAR (AVI√ÉO VERDE)
  window.enviarGrupoCondominioPorObjeto = async (it) => {
    if (!it) return;
    const msg = `üì¢ *CONTROLE DE ENCOMENDA - PORTARIA* \n\nüë§ *Morador:* ${it.morador}\nüè¢ *Unidade:* ${it.apto} - Bloco ${it.bloco}\nüì¶ *Produto:* ${it.descricao}\nüöö *Empresa:* ${it.empresa}\nüè∑Ô∏è *Remetente:* ${it.remetente}\nüî¢ *NF/Doc:* ${it.nf}\nüëÆ *Recebido por:* ${it.recebedor}\n‚è∞ *Chegada:* ${it.data} √†s ${it.hora}\n‚è≥ *Portaria at√©:* ${it.permanencia || 'N/A'}`;
    
    if (it.foto && navigator.share) {
        try {
            const response = await fetch(it.foto);
            const blob = await response.blob();
            const file = new File([blob], 'encomenda.jpg', { type: 'image/jpeg' });
            await navigator.share({ files: [file], title: 'TrackEasy', text: msg });
            return;
        } catch (e) {}
    }
    window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
  };

  // 4. WHATSAPP MORADOR (SINO AZUL)
  window.enviarWhatsFirebase = async function(id, tipoAviso) {
    const it = window.db.find(d => d.id === id);
    if (!it) return;
    const idFirebase = (it.apto + it.bloco).toUpperCase();
    try {
      const docRef = doc(dbFirebase, "moradores", idFirebase);
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const dados = docSnap.data();
        let num = String(dados.whatsapp1).replace(/\D/g, ''); 
        if (num.length <= 11) num = '55' + num;

        let msg = "";
        if (tipoAviso === 'portaria') {
          let perm = it.permanencia ? `\n‚ö†Ô∏è *Aten√ß√£o:* Portaria at√© √†s *${it.permanencia}*.` : '';
          msg = `Ol√°! üëã Encomenda na portaria!\nüë§ *Para:* ${it.morador}\nüè¢ *Apto:* ${it.apto}-${it.bloco}\nüì¶ *Item:* ${it.descricao}${perm}\nAt√© j√°! üì¶‚ú®`;
        } else {
          msg = `Ol√°! üëã Sua encomenda est√° na *MENSAGERIA* pronta para retirada.\nüè¢ *Apto:* ${it.apto}-${it.bloco}\nüì¶ *Item:* ${it.descricao}\nBom dia! üì¶‚ú®`;
        }
        
        document.getElementById('wa-numero-display').innerText = `Apto: ${idFirebase} | +${num}`;
        const btn = document.getElementById('btn-wa-enviar');
        btn.href = `https://wa.me/${num}?text=${encodeURIComponent(msg)}`;
        btn.onclick = async () => {
          const fbId = getFbId(id);
          if (fbId) {
            const up = tipoAviso === 'portaria' ? {notificadoPortariaMorador:true} : {notificadoMensageria:true};
            await updateDoc(doc(dbFirebase, "encomendas", fbId), up);
          }
          document.getElementById('modal-whatsapp').classList.add('hidden');
        };
        document.getElementById('modal-whatsapp').classList.remove('hidden');
      } else { alert("Morador sem WhatsApp no banco!"); }
    } catch (e) { alert("Erro de conex√£o."); }
  };

  // 5. FUN√á√ïES DE APOIO
  window.enviarAvisoMorador = (id) => window.enviarWhatsFirebase(id, 'portaria');
  window.enviarAvisoMensageria = (id) => window.enviarWhatsFirebase(id, 'mensageria');
  window.closeBaixaModal = () => document.getElementById('modal-baixa').classList.add('hidden');
  window.closeEditModal = () => document.getElementById('modal-edit').classList.add('hidden');
  
  window.openBaixaModal = (id, origem) => {
    const it = window.db.find(d => d.id === id);
    if (!it) return;
    window.baixaTargetId = id; window.baixaTargetOrigem = origem;
    document.getElementById('baixa-info-morador').innerText = `Apto ${it.apto}${it.bloco} - ${it.morador}`;
    document.getElementById('modal-baixa').classList.remove('hidden');
  };

  window.confirmarBaixaReal = async () => {
    const fbId = getFbId(window.baixaTargetId);
    if (!fbId) return;
    const dest = window.baixaTargetOrigem === 'mensageria' ? 'entregue_mensageria' : 'morador';
    await updateDoc(doc(dbFirebase, "encomendas", fbId), {
        status: 'entregue', saida: new Date().toISOString(),
        entreguePor: document.getElementById('baixa-entregador').value || "Portaria",
        retiradoPor: document.getElementById('baixa-retirado').value || "O Pr√≥prio",
        destino: dest
    });
    window.closeBaixaModal();
  };

  window.darBaixaDiretaMensageria = async (id) => {
    const fbId = getFbId(id);
    if(fbId) await updateDoc(doc(dbFirebase, "encomendas", fbId), { status: 'entregue', saida: new Date().toISOString(), destino: 'mensageria' });
  };

  window.excluirUm = async (id) => { if(confirm("Apagar?")){ const fbId=getFbId(id); if(fbId) await deleteDoc(doc(dbFirebase,"encomendas",fbId)); } };

  window.validarUnidade = (txt) => {
    const clean = txt.toUpperCase().replace(/\s/g, '');
    const num = clean.match(/\d+/); const blk = clean.match(/[JP]/);
    if (!num || !blk) return { ok: false, msg: "Bloco?" };
    return { ok: true, apto: num[0], bloco: blk[0], msg: `‚úì ${blk[0]}-${num[0]}` };
  };

  window.validarInput = (el) => {
    const res = window.validarUnidade(el.value);
    const fb = document.getElementById('feedback-val');
    fb.innerText = res.msg;
    fb.className = `text-[10px] mt-1 font-bold ${res.ok ? 'text-emerald-500' : 'text-red-400'}`;
    document.getElementById('btn-gravar').disabled = !res.ok;
  };

  window.switchTab = (t) => {
    window.abaAtiva = t; window.expandidoKey = null; window.blocoFiltro = '';
    const ativo = "bg-white text-blue-600 shadow-sm";
    const inativo = "text-slate-500 hover:bg-slate-200";
    document.getElementById('tab-p').className = `px-3 py-2 text-[10px] font-bold rounded-lg transition-all ${t==='pendentes'?ativo:inativo}`;
    document.getElementById('tab-m').className = `px-3 py-2 text-[10px] font-bold rounded-lg transition-all ${t==='mensageria'?ativo:inativo}`;
    document.getElementById('tab-h').className = `px-3 py-2 text-[10px] font-bold rounded-lg transition-all ${t==='entregues'?ativo:inativo}`;
    document.getElementById('area-registro').style.display = t==='pendentes'?'block':'none';
    window.render();
  };

  window.setFastFilter = (f) => { window.blocoFiltro = f; window.render(); };
  window.toggleExpand = (k) => { window.expandidoKey = window.expandidoKey === k ? null : k; window.render(); };
  window.processarFoto = (input) => {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = 600; canvas.height = (img.height/img.width)*600;
          canvas.getContext("2d").drawImage(img, 0, 0, 600, canvas.height);
          window.currentPhoto = canvas.toDataURL("image/jpeg", 0.6);
          document.getElementById('preview-img').src = window.currentPhoto;
          document.getElementById('photo-container').classList.remove('hidden');
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    }
  };

  // 6. RENDERIZA√á√ÉO FINAL (PADRONIZADA)
  window.render = function() {
    let base = [];
    if (window.abaAtiva === 'pendentes') base = window.db.filter(d => d.status === 'pendente');
    else if (window.abaAtiva === 'mensageria') base = window.db.filter(d => d.status === 'entregue' && d.destino === 'mensageria');
    else base = window.db.filter(d => d.status === 'entregue' && d.destino !== 'mensageria');

    const grupos = {};
    base.forEach(d => {
        if(window.blocoFiltro && d.bloco !== window.blocoFiltro) return;
        const k = `${d.bloco}-${d.apto}`;
        if(!grupos[k]) grupos[k] = { b: d.bloco, a: d.apto, itens: [], total: 0, morador: d.morador, notif: false };
        grupos[k].itens.push(d); grupos[k].total += d.qtd;
        if(window.abaAtiva==='pendentes' && d.notificadoPortariaMorador) grupos[k].notif = true;
        if(window.abaAtiva!=='pendentes' && d.notificadoMensageria) grupos[k].notif = true;
    });

    const filtrados = Object.values(grupos).sort((x,y) => x.b.localeCompare(y.b) || x.a.localeCompare(y.a, undefined, {numeric:true}));
    const container = document.getElementById('render-container');
    container.innerHTML = filtrados.length === 0 ? `<div class="p-10 text-center text-slate-400 font-bold text-xs uppercase">Vazio</div>` : '';

    filtrados.forEach(g => {
        const key = `${g.b}-${g.a}`; const isExp = window.expandidoKey === key;
        const card = document.createElement('div');
        card.className = "bg-white rounded-2xl border border-slate-100 shadow-sm mb-3 overflow-hidden animate-fade-in";
        card.innerHTML = `
            <div onclick="window.toggleExpand('${key}')" class="p-4 flex items-center gap-3 cursor-pointer">
                <div class="w-12 h-12 flex items-center justify-center rounded-xl font-bold bg-blue-600 text-white">${g.b}</div>
                <div class="flex-1">
                    <h3 class="text-sm font-black uppercase">${g.a} - ${g.morador} ${g.notif ? '‚úÖ' : ''}</h3>
                    <span class="text-[9px] font-bold text-slate-400 uppercase">${g.total} VOLS</span>
                </div>
                <i data-lucide="${isExp?'chevron-up':'chevron-down'}" class="text-slate-300"></i>
            </div>
            ${isExp ? `<div class="bg-slate-50 border-t p-4 space-y-4">
                ${g.itens.map(it => `
                    <div class="bg-white p-4 rounded-xl border relative shadow-sm">
                        <div class="flex gap-4 mb-4">
                            ${it.foto ? `<img src="${it.foto}" class="w-16 h-16 rounded-lg object-cover">` : `<div class="w-16 h-16 bg-slate-100 rounded-lg"></div>`}
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <p class="text-[11px] font-black text-blue-700 uppercase">${it.remetente}</p>
                                    <div class="flex gap-2">
                                        ${window.abaAtiva === 'pendentes' ? `
                                            <button onclick="window.enviarGrupoCondominioPorObjeto(window.db.find(d => d.id === ${it.id}))" class="p-1.5 bg-emerald-500 text-white rounded-lg"><i data-lucide="send" class="w-4 h-4"></i></button>
                                            <button onclick="window.enviarAvisoMorador(${it.id})" class="p-1.5 bg-blue-500 text-white rounded-lg"><i data-lucide="bell" class="w-4 h-4"></i></button>
                                        ` : `
                                            <button onclick="window.enviarAvisoMensageria(${it.id})" class="p-1.5 bg-blue-500 text-white rounded-lg"><i data-lucide="bell" class="w-4 h-4"></i></button>
                                        `}
                                        <button onclick="window.excluirUm(${it.id})" class="p-1.5 bg-red-50 text-red-400 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                                <p class="text-[10px] text-slate-600">${it.empresa}</p>
                            </div>
                        </div>
                        ${window.abaAtiva === 'pendentes' ? `<div class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t">
                            <button onclick="window.openBaixaModal(${it.id}, 'portaria')" class="bg-emerald-600 text-white py-2 rounded-lg text-[9px] font-black uppercase">Entrega</button>
                            <button onclick="window.darBaixaDiretaMensageria(${it.id})" class="bg-blue-600 text-white py-2 rounded-lg text-[9px] font-black uppercase">Mensageria</button>
                        </div>` : ''}
                    </div>
                `).join('')}
            </div>` : ''}
        `;
        container.appendChild(card);
    });
    lucide.createIcons();
    document.getElementById('count-p').innerText = window.db.filter(d => d.status === 'pendente').length;
    document.getElementById('count-m').innerText = window.db.filter(d => d.status === 'entregue' && d.destino === 'mensageria').length;
    document.getElementById('count-e').innerText = window.db.filter(d => d.status === 'entregue' && d.destino !== 'mensageria').length;
  };
</script>
</body>
</html>












