<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portaria Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        .tab-active { background-color: white; color: #2563eb; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tab-inactive { color: #64748b; }
        .animate-fade-in { animation: fadeIn 0.15s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        
        .check-container { display: flex; align-items: center; justify-content: center; width: 22px; height: 22px; border-radius: 50%; border: 2px solid #cbd5e1; transition: all 0.2s; }
        .check-selected { border-color: #ef4444; background-color: #ef4444; color: white; }

        .input-field { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background-color: #f8fafc; font-weight: 600; font-size: 13px; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #2563eb; ring: 2px; ring-color: #2563eb; background-color: #fff; }

        .photo-preview { width: 80px; height: 80px; border-radius: 12px; object-fit: cover; border: 2px solid #2563eb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @media print {
            header, #area-registro, #area-acoes, .no-print, .btn-acao, input, .filters-container { display: none !important; }
            body { background: white; padding: 0; }
            .card-unidade { border: 1px solid #eee !important; break-inside: avoid; margin-bottom: 10px; border-radius: 8px !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-10">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 no-print">
        <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i data-lucide="package" class="w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">Portaria Control</h1>
            </div>
            
            <div class="flex bg-slate-100 p-1 rounded-xl">
                <button id="tab-p" onclick="switchTab('pendentes')" class="px-3 py-2 text-[10px] font-bold rounded-lg tab-active uppercase">Portaria</button>
                <button id="tab-h" onclick="switchTab('entregues')" class="px-3 py-2 text-[10px] font-bold rounded-lg tab-inactive uppercase">Histórico</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto px-4 py-6 space-y-6">
        
        <div class="grid grid-cols-2 gap-4 no-print">
            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm text-center">
                <p class="text-[10px] font-bold uppercase text-slate-400 mb-1">Na Portaria</p>
                <div class="flex items-end justify-center gap-2">
                    <span id="count-p" class="text-3xl font-black text-blue-600">0</span>
                    <span class="text-[10px] text-slate-400 mb-1 font-bold">VOLS</span>
                </div>
            </div>
            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm text-center">
                <p class="text-[10px] font-bold uppercase text-slate-400 mb-1">Entregas Turno</p>
                <div class="flex items-end justify-center gap-2">
                    <span id="count-e" class="text-3xl font-black text-emerald-600">0</span>
                    <span class="text-[10px] text-slate-400 mb-1 font-bold">UNIDS</span>
                </div>
            </div>
        </div>

        <section id="area-registro" class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm no-print">
            <h2 class="text-[10px] font-black mb-4 flex items-center gap-2 text-slate-400 uppercase tracking-widest">
                <i data-lucide="camera" class="w-4 h-4 text-blue-600"></i> Novo Registro Fotográfico
            </h2>
            <form id="form-main" onsubmit="handleRegistrar(event)" class="space-y-6">
                
                <div class="flex items-center gap-4 bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300">
                    <div id="photo-container" class="hidden">
                        <img id="preview-img" src="" class="photo-preview">
                    </div>
                    <div class="flex-1">
                        <label for="input-foto" class="flex flex-col items-center justify-center cursor-pointer py-3 px-4 bg-blue-50 border border-blue-200 text-blue-600 rounded-xl font-bold text-xs uppercase hover:bg-blue-100 transition-all">
                            <i data-lucide="camera" class="w-6 h-6 mb-1"></i>
                            <span>Tirar Foto da Encomenda</span>
                            <input type="file" id="input-foto" accept="image/*" capture="environment" class="hidden" onchange="processarFoto(this)">
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 border-b border-slate-100 pb-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Unidade (Apto)</label>
                        <input id="input-unidade" type="text" placeholder="Ex: 111J" oninput="validarInput(this)" class="input-field uppercase">
                        <p id="feedback-val" class="text-[9px] mt-1 ml-1 font-bold text-slate-400">Pendente</p>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Nome do Morador</label>
                        <input id="input-morador" type="text" placeholder="Nome do Morador" class="input-field">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 border-b border-slate-100 pb-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Empresa / Estafeta</label>
                        <input id="input-empresa" type="text" placeholder="Ex: Amazon, Mercado Livre" class="input-field">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Remetente</label>
                        <input id="input-remetente" type="text" placeholder="Quem enviou" class="input-field">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4 border-b border-slate-100 pb-4">
                    <div class="col-span-2">
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Descrição do Produto</label>
                        <input id="input-descricao" type="text" placeholder="Ex: Caixa Pequena, Envelope" class="input-field">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Volumes</label>
                        <input id="input-qtd" type="number" value="1" min="1" class="input-field text-center">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Nota Fiscal / Pedido</label>
                        <input id="input-nf" type="text" placeholder="Nº Documento" class="input-field">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1">Nome do Porteiro</label>
                        <input id="input-recebedor" type="text" placeholder="Porteiro Recebedor" class="input-field">
                    </div>
                </div>

                <button id="btn-gravar" type="submit" disabled class="w-full bg-blue-600 h-[50px] text-white font-black rounded-2xl active:scale-95 disabled:opacity-50 transition-all uppercase text-xs shadow-lg shadow-blue-100">
                    Gravar Registro Completo
                </button>
            </form>
        </section>

        <div id="area-acoes" class="flex flex-col gap-3 no-print">
            <div class="relative">
                <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 w-5 h-5"></i>
                <input id="input-busca" type="text" placeholder="Pesquisar por Morador, Apto ou Remetente..." oninput="filtrar(this.value)"
                    class="w-full pl-12 pr-4 py-4 rounded-2xl border border-slate-200 bg-white shadow-sm outline-none font-medium text-sm focus:ring-2 focus:ring-blue-500/20">
            </div>

            <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                <button onclick="setFastFilter('')" id="ff-all" class="whitespace-nowrap px-4 py-2 rounded-xl bg-blue-600 text-white text-[10px] font-bold uppercase transition-all">Todos</button>
                <button onclick="setFastFilter('J')" id="ff-j" class="whitespace-nowrap px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-500 text-[10px] font-bold uppercase transition-all">Bloco J</button>
                <button onclick="setFastFilter('P')" id="ff-p" class="whitespace-nowrap px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-500 text-[10px] font-bold uppercase transition-all">Bloco P</button>
                <button id="ff-token" onclick="setTokenFilter('com')" class="hidden whitespace-nowrap px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-500 text-[10px] font-bold uppercase transition-all">Com Token</button>
                <button id="ff-notoken" onclick="setTokenFilter('sem')" class="hidden whitespace-nowrap px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-500 text-[10px] font-bold uppercase transition-all">Sem Token</button>
            </div>
            
            <div id="controles-historico" class="hidden flex flex-col gap-2">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportarDados()" class="py-3 bg-white border border-slate-200 text-slate-600 text-[10px] font-bold rounded-xl flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-3 h-3 text-blue-500"></i> Backup JSON
                    </button>
                    <label class="py-3 bg-white border border-slate-200 text-slate-600 text-[10px] font-bold rounded-xl flex items-center justify-center gap-2 cursor-pointer">
                        <i data-lucide="upload" class="w-3 h-3 text-emerald-500"></i> Importar Backup
                        <input type="file" class="hidden" accept=".json" onchange="importarDados(this)">
                    </label>
                </div>
                <button onclick="limparHistorico()" class="w-full py-2 text-red-500 text-[9px] font-black uppercase">Limpar Histórico Completo</button>
            </div>
        </div>

        <div id="render-container" class="space-y-4 pb-10"></div>

    </main>

    <script>
        let db = JSON.parse(localStorage.getItem('portaria_v23')) || [];
        let abaAtiva = 'pendentes';
        let termoBusca = '';
        let blocoFiltro = '';
        let tokenFiltro = ''; 
        let currentPhoto = null;
        let expandidoKey = null;

        function salvar() {
            try {
                localStorage.setItem('portaria_v23', JSON.stringify(db));
                render();
            } catch (e) {
                alert("Memória cheia! Exporte os dados e limpe o histórico.");
            }
        }

        // --- Foto e Compressão ---
        function processarFoto(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const max_w = 800;
                        let w = img.width, h = img.height;
                        if (w > max_w) { h *= max_w / w; w = max_w; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext("2d").drawImage(img, 0, 0, w, h);
                        currentPhoto = canvas.toDataURL("image/jpeg", 0.7);
                        document.getElementById('preview-img').src = currentPhoto;
                        document.getElementById('photo-container').classList.remove('hidden');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        window.addPhotoToRecord = (id, input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = 600; canvas.height = (img.height / img.width) * 600;
                        canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);
                        const compressed = canvas.toDataURL("image/jpeg", 0.6);
                        const item = db.find(d => d.id === id);
                        if (item) { item.foto = compressed; salvar(); }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- Dados ---
        function exportarDados() {
            const blob = new Blob([JSON.stringify(db, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `portaria_backup_${Date.now()}.json`; a.click();
        }

        function importarDados(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        if (confirm("Isso irá substituir os dados atuais. Continuar?")) {
                            db = data; salvar();
                        }
                    }
                } catch(err) { alert("Erro no arquivo"); }
            };
            reader.readAsText(file);
        }

        // --- Registro ---
        function validarUnidade(txt) {
            const clean = txt.toUpperCase().replace(/[.\s,;-]/g, '');
            const num = clean.match(/\d+/); const blk = clean.match(/[JP]/);
            if (!num || !blk) return { ok: false, msg: "Falta J/P" };
            const n = parseInt(num[0]); const b = blk[0];
            if (n < 11 || n > 181 || n % 10 !== 1) return { ok: false, msg: "Inválida" };
            return { ok: true, apto: n, bloco: b, msg: `✓ Bloco ${b} - Apto ${n}` };
        }

        function validarInput(el) {
            const res = validarUnidade(el.value);
            const feedback = document.getElementById('feedback-val');
            feedback.innerText = res.msg;
            feedback.className = `text-[10px] mt-1 ml-1 font-bold ${res.ok ? 'text-emerald-500' : 'text-red-400'}`;
            document.getElementById('btn-gravar').disabled = !res.ok;
        }

        // --- FUNÇÃO DE AUXÍLIO PARA WHATSAPP (CONVERTE FOTO) ---
        function dataURLtoFile(dataurl, filename) {
            var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
            bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--){ u8arr[n] = bstr.charCodeAt(n); }
            return new File([u8arr], filename, {type:mime});
        }

        async function handleRegistrar(e) {
            e.preventDefault();
            const res = validarUnidade(document.getElementById('input-unidade').value);
            if (!res.ok) return;

            const now = new Date();
            const dadosRegistro = {
                id: Date.now() + Math.random(),
                apto: res.apto.toString(), bloco: res.bloco,
                morador: document.getElementById('input-morador').value || "Não informado",
                empresa: document.getElementById('input-empresa').value || "Não informado",
                remetente: document.getElementById('input-remetente').value || "Não informado",
                descricao: document.getElementById('input-descricao').value || "Volume",
                nf: document.getElementById('input-nf').value || "S/N",
                recebedor: document.getElementById('input-recebedor').value || "Porteiro",
                qtd: parseInt(document.getElementById('input-qtd').value) || 1,
                foto: currentPhoto,
                data: now.toLocaleDateString('pt-PT'),
                hora: now.toLocaleTimeString('pt-PT', {hour: '2-digit', minute:'2-digit'}),
                timestamp: now.toISOString(),
                saida: null, status: 'pendente', destino: null, tokens: []
            };

            db.push(dadosRegistro);

            // --- NOVO: BLOCO DE COMPARTILHAMENTO WHATSAPP ---
            if (navigator.share && currentPhoto) {
                const fotoParaWhats = dataURLtoFile(currentPhoto, 'encomenda.jpg');
                const mensagemWhats = `NOME RECEBEDOR: ${dadosRegistro.recebedor}\n` +
                                     `EMPRESA : ${dadosRegistro.empresa}\n` +
                                     `DESCRIÇÃO DO PRODUTO : ${dadosRegistro.qtd} ${dadosRegistro.descricao}\n\n` +
                                     `NOME MORADOR : ${dadosRegistro.morador}\n` +
                                     `DATA : ${dadosRegistro.data}\n` +
                                     `HORA : ${dadosRegistro.hora}\n` +
                                     `APTO : ${dadosRegistro.apto}${dadosRegistro.bloco}\n\n` +
                                     `EMPRESA/NOME DO REMETENTE :${dadosRegistro.remetente}\n` +
                                     `NUMERO PEDIDO/ NF / ORDEM DE SERVIÇO : ${dadosRegistro.nf}`;
                try {
                    await navigator.share({
                        files: [fotoParaWhats],
                        text: mensagemWhats
                    });
                } catch (err) { console.log("Compartilhamento cancelado."); }
            }
            // --- FIM DO BLOCO WHATSAPP ---

            document.getElementById('form-main').reset();
            document.getElementById('photo-container').classList.add('hidden');
            currentPhoto = null;
            document.getElementById('feedback-val').innerText = "Aguardando...";
            salvar();
        }

        // --- Filtros ---
        function switchTab(t) {
            abaAtiva = t; expandidoKey = null; blocoFiltro = ''; tokenFiltro = ''; termoBusca = '';
            document.getElementById('input-busca').value = '';
            document.getElementById('tab-p').className = `px-3 py-2 text-[10px] font-bold rounded-lg uppercase ${t === 'pendentes' ? 'tab-active' : 'tab-inactive'}`;
            document.getElementById('tab-h').className = `px-3 py-2 text-[10px] font-bold rounded-lg uppercase ${t === 'entregues' ? 'tab-active' : 'tab-inactive'}`;
            document.getElementById('area-registro').style.display = t === 'pendentes' ? 'block' : 'none';
            document.getElementById('controles-historico').style.display = t === 'entregues' ? 'flex' : 'none';
            document.getElementById('ff-token').classList.toggle('hidden', t !== 'entregues');
            document.getElementById('ff-notoken').classList.toggle('hidden', t !== 'entregues');
            setFastFilter('');
        }

        function filtrar(v) { termoBusca = v.toLowerCase(); render(); }
        
        function setFastFilter(f) {
            blocoFiltro = f;
            ['all', 'j', 'p'].forEach(id => {
                const el = document.getElementById(`ff-${id}`);
                const match = (id==='all' && f==='') || (id==='j' && f==='J') || (id==='p' && f==='P');
                el.className = `whitespace-nowrap px-4 py-2 rounded-xl text-[10px] font-bold uppercase transition-all ${match ? 'bg-blue-600 text-white' : 'bg-white border border-slate-200 text-slate-500'}`;
            });
            render();
        }

        function setTokenFilter(f) {
            tokenFiltro = tokenFiltro === f ? '' : f;
            ['token', 'notoken'].forEach(id => {
                const el = document.getElementById(`ff-${id}`);
                const match = (id==='token' && tokenFiltro==='com') || (id==='notoken' && tokenFiltro==='sem');
                el.className = `whitespace-nowrap px-4 py-2 rounded-xl text-[10px] font-bold uppercase transition-all ${match ? 'bg-indigo-600 text-white' : 'bg-white border border-slate-200 text-slate-500'}`;
            });
            render();
        }

        function toggleExpand(key) { expandidoKey = expandidoKey === key ? null : key; render(); }

        window.darBaixa = (blk, apt, dest) => {
            const container = document.getElementById(`obs-c-${blk}-${apt}`);
            const tks = [];
            if (container) container.querySelectorAll('.obs-in').forEach(i => { if(i.value.trim()) tks.push(i.value.trim()); });

            db.forEach(d => {
                if (d.bloco === blk && d.apto === apt && d.status === 'pendente') {
                    d.status = 'entregue'; d.saida = new Date().toISOString(); d.destino = dest; d.tokens = tks;
                }
            });
            expandidoKey = null; salvar();
        }

        window.excluirUm = (id) => { if(confirm("Apagar permanentemente?")) { db = db.filter(d => d.id !== id); salvar(); } }
        window.limparHistorico = () => { if(confirm("Apagar todo histórico do turno?")) { db = db.filter(d => d.status === 'pendente'); salvar(); } }

        function render() {
            const pendentes = db.filter(d => d.status === 'pendente');
            const entregues = db.filter(d => d.status === 'entregue');
            document.getElementById('count-p').innerText = pendentes.reduce((a, b) => a + b.qtd, 0);
            document.getElementById('count-e').innerText = entregues.length;

            const lista = abaAtiva === 'pendentes' ? pendentes : entregues;
            const grupos = {};
            
            lista.forEach(d => {
                const k = `${d.bloco}-${d.apto}`;
                if (!grupos[k]) grupos[k] = { b: d.bloco, a: d.apto, itens: [], total: 0, morador: d.morador, hasToken: false };
                grupos[k].itens.push(d);
                grupos[k].total += d.qtd;
                if(d.tokens && d.tokens.length > 0) grupos[k].hasToken = true;
            });

            const filtrados = Object.values(grupos)
                .filter(g => {
                    const matchBusca = g.morador.toLowerCase().includes(termoBusca) || 
                                     g.a.includes(termoBusca) || 
                                     g.itens.some(i => i.remetente.toLowerCase().includes(termoBusca));
                    const matchBloco = !blocoFiltro || (blocoFiltro === g.b);
                    const matchToken = !tokenFiltro || (tokenFiltro === 'com' ? g.hasToken : !g.hasToken);
                    return matchBusca && matchBloco && matchToken;
                })
                .sort((x, y) => x.b.localeCompare(y.b) || x.a.localeCompare(y.a, undefined, {numeric: true}));

            const container = document.getElementById('render-container');
            container.innerHTML = '';

            filtrados.forEach(g => {
                const key = `${g.b}-${g.a}`;
                const isExp = expandidoKey === key;
                const card = document.createElement('div');
                card.className = `card-unidade bg-white rounded-2xl border ${abaAtiva==='pendentes'&&g.total>1?'border-orange-200 ring-2 ring-orange-50':'border-slate-100'} shadow-sm overflow-hidden mb-3 animate-fade-in`;
                
                card.innerHTML = `
                    <div onclick="toggleExpand('${key}')" class="p-4 flex items-center gap-3 cursor-pointer transition-all active:bg-slate-50">
                        <div class="w-12 h-12 flex items-center justify-center rounded-xl font-bold text-lg ${abaAtiva==='entregues'?'bg-slate-100 text-slate-400 border border-dashed':'bg-blue-600 text-white shadow-md'}">${g.b}</div>
                        <div class="flex-1">
                            <h3 class="text-sm font-black text-slate-800 uppercase">Apto ${g.a} - ${g.morador}</h3>
                            <div class="flex gap-2 items-center">
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded-full ${abaAtiva==='pendentes'&&g.total>1?'bg-orange-500 text-white':'bg-slate-100 text-slate-400'} uppercase">${g.total} VOLS</span>
                                ${abaAtiva==='entregues' ? (g.hasToken ? '<span class="text-[8px] bg-blue-100 text-blue-600 font-black px-1.5 rounded uppercase">Com Token</span>' : '<span class="text-[8px] bg-slate-100 text-slate-400 font-black px-1.5 rounded uppercase">Sem Token</span>') : ''}
                            </div>
                        </div>
                        <i data-lucide="${isExp?'chevron-up':'chevron-down'}" class="text-slate-300"></i>
                    </div>
                    ${isExp ? `<div class="bg-slate-50 border-t border-slate-100 p-4 space-y-4">
                        ${g.itens.map(it => `
                            <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm relative animate-fade-in">
                                <div class="flex gap-4 mb-4">
                                    <div class="relative">
                                        ${it.foto ? `<img src="${it.foto}" class="w-20 h-20 rounded-lg object-cover border border-slate-200" onclick="window.open(this.src)">` : `
                                            <label class="w-20 h-20 bg-slate-100 rounded-lg flex flex-col items-center justify-center text-blue-500 cursor-pointer no-print">
                                                <i data-lucide="camera" class="w-5 h-5"></i><span class="text-[7px] font-black uppercase text-center">+ Add Foto</span>
                                                <input type="file" accept="image/*" capture="environment" class="hidden" onchange="addPhotoToRecord(${it.id}, this)">
                                            </label>`}
                                    </div>
                                    <div class="flex-1 space-y-1">
                                        <div class="mb-1"><p class="text-[8px] font-black text-slate-400 uppercase">Remetente</p><p class="text-[11px] font-black text-blue-700 uppercase">${it.remetente}</p></div>
                                        <div><p class="text-[8px] font-black text-slate-400 uppercase">Entrega por</p><p class="text-[10px] font-bold text-slate-700 uppercase">${it.empresa}</p></div>
                                        <div><p class="text-[8px] font-black text-slate-400 uppercase">Informação do Produto</p><p class="text-[10px] font-bold italic text-slate-600">${it.descricao}</p></div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-x-2 gap-y-3 border-t pt-2 text-[9px] font-black uppercase text-slate-400">
                                    <div><p class="text-[7px]">Documento / NF</p><p class="text-slate-700">${it.nf}</p></div>
                                    <div><p class="text-[7px]">Porteiro Recebedor</p><p class="text-slate-700">${it.recebedor}</p></div>
                                    <div><p class="text-[7px]">Entrada em</p><p class="text-slate-700">${it.data} às ${it.hora}</p></div>
                                    ${it.saida ? `<div><p class="text-[7px] text-emerald-500">Saída em</p><p class="text-emerald-600">${new Date(it.saida).toLocaleString('pt-PT')}</p></div>` : ''}
                                </div>
                                ${it.saida ? `<div class="mt-3 p-2 rounded-lg border-l-4 ${it.destino==='mensageria'?'bg-blue-50 border-blue-600 text-blue-700':'bg-emerald-50 border-emerald-600 text-emerald-700'} uppercase text-[9px] font-black">Destino: ${it.destino==='mensageria'?'Via Mensageria':'Entrega ao Morador'}</div>` : ''}
                                ${it.tokens && it.tokens.length > 0 ? `<div class="mt-2 p-2 bg-slate-50 rounded border flex flex-wrap gap-1">${it.tokens.map(t => `<span class="bg-white border border-slate-200 px-2 py-0.5 rounded font-black text-[10px] text-slate-600 shadow-sm">${t}</span>`).join('')}</div>` : ''}
                                ${abaAtiva==='entregues' ? `<button onclick="excluirUm(${it.id})" class="absolute top-4 right-4 text-slate-200 hover:text-red-500 no-print transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                            </div>
                        `).join('')}
                        ${abaAtiva === 'pendentes' ? `<div class="pt-2 no-print space-y-3 border-t">
                            <div class="flex justify-between items-center"><label class="text-[9px] font-black text-slate-400 uppercase">Token / Código de Saída:</label><button onclick="addObs('obs-c-${g.b}-${g.a}')" class="text-[9px] font-black text-blue-600 bg-blue-50 px-2 py-1.5 rounded-lg active:bg-blue-100 transition-all">+ ADICIONAR CAMPO</button></div>
                            <div id="obs-c-${g.b}-${g.a}" class="space-y-2"><input type="text" placeholder="Escreva o token aqui..." class="obs-in w-full p-3 rounded-xl border border-slate-200 bg-white font-bold text-xs outline-none focus:ring-2 focus:ring-blue-500"></div>
                            <div class="grid grid-cols-2 gap-3 mt-4">
                                <button onclick="darBaixa('${g.b}','${g.a}','morador')" class="py-4 bg-emerald-600 text-white rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-emerald-50 active:scale-95 transition-all">Entrega Morador</button>
                                <button onclick="darBaixa('${g.b}','${g.a}','mensageria')" class="py-4 bg-blue-600 text-white rounded-2xl font-black text-[10px] uppercase shadow-lg shadow-blue-50 active:scale-95 transition-all">Via Mensageria</button>
                            </div>
                        </div>` : ''}
                    </div>` : ''}
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        window.addObs = (id) => {
            const div = document.createElement('div'); div.className = "flex gap-2 animate-fade-in";
            div.innerHTML = `<input type="text" placeholder="Token" class="obs-in flex-1 p-3 rounded-xl border border-slate-200 bg-white font-bold text-xs outline-none"><button onclick="this.parentElement.remove()" class="p-2 text-red-400 hover:text-red-600"><i data-lucide="x" class="w-4 h-4"></i></button>`;
            document.getElementById(id).appendChild(div);
            lucide.createIcons();
        }

        window.onload = () => { render(); };
    </script>
</body>
</html>
